---
# This workflow is generated by terraform! Go to scripts/generate-gha-yaml and run `terraform apply`
name: "Apply"

concurrency:
  group: apply
  cancel-in-progress: false # don't cause other jobs to leave state-locks in place

defaults:
  run:
    shell: bash

env:
  # the true value can't be '' because that evaluates to false and messes up the ternary logic
  AFFECTED_ROOTS_OPTION: ${{ (! inputs.run_all_roots) && '--affected' || '' }}
  DRY_RUN: ${{ (inputs.dry_run) && 'true' || '' }}

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_all_roots:
        description: "Apply all roots (including unchanged)"
        type: boolean
      dry_run:
        description: "Only queue up the jobs, don't actually run `terraform apply`"
        type: boolean

permissions: read-all

jobs:
  apply-test:
    uses: ./.github/workflows/reusable-terraform-apply.yml
    permissions:
      actions: write
      contents: read
      packages: read
    if: 3
    with:
      aws_profile: foo
      environment: dev
      matrix_json: '{"include": [{"region": "us-west-2", "environment": "dev","domain": "platform","globe": "gold","organization": "acme"}]}'
      root_name: vpc
      dry_run: $DRY_RUN
    secrets: inherit # pragma: allowlist secret
